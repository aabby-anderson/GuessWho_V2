<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Custom Guess Who ‚Äì Two Player</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin:0; padding:0; min-height:100vh; position:relative; overflow-x:hidden; }
body::before { content: ''; position: absolute; top: -50%; right: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%); animation: rotate 30s linear infinite; }
@keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
h1,h2,h3 { text-align:center; margin:10px 0; position:relative; z-index:1; }
h1 { color: white; font-weight: 800; font-size: 36px; text-shadow: 0 4px 8px rgba(0,0,0,0.2); letter-spacing: -0.5px; }
h2 { color: white; font-weight: 700; font-size: 28px; text-shadow: 0 2px 4px rgba(0,0,0,0.15); }
h3 { color: #1f2937; font-weight: 700; font-size: 20px; }
.box { background:rgba(255,255,255,0.98); border-radius:24px; padding:24px; margin:16px auto; max-width:1000px; box-shadow:0 20px 60px rgba(0,0,0,.3), 0 0 0 1px rgba(255,255,255,0.5) inset; backdrop-filter:blur(20px); position:relative; z-index:1; }
.auth-box { background:rgba(255,255,255,0.98); border-radius:28px; padding:48px; margin:60px auto; max-width:480px; box-shadow:0 30px 80px rgba(0,0,0,.4), 0 0 0 1px rgba(255,255,255,0.6) inset; backdrop-filter:blur(20px); position:relative; z-index:1; }
.auth-box h1 { color: #1f2937; margin-bottom: 12px; font-size: 32px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.controls { display:flex; flex-wrap:wrap; justify-content:center; gap:10px; margin-bottom:12px; }
button { padding:14px 24px; border:none; border-radius:14px; cursor:pointer; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; font-size:16px; font-weight:700; min-width:160px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4), 0 0 0 1px rgba(255,255,255,0.1) inset; position:relative; overflow:hidden; }
button::before { content: ''; position: absolute; top: 50%; left: 50%; width: 0; height: 0; border-radius: 50%; background: rgba(255,255,255,0.2); transform: translate(-50%, -50%); transition: width 0.6s, height 0.6s; }
button:hover::before { width: 300px; height: 300px; }
button:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 10px 30px rgba(102, 126, 234, 0.6), 0 0 0 1px rgba(255,255,255,0.2) inset; }
button:active { transform: translateY(-1px) scale(0.98); }
button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
button:disabled:hover { transform: none; box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4), 0 0 0 1px rgba(255,255,255,0.1) inset; }
input { padding:14px 18px; border:2px solid #e5e7eb; border-radius:14px; font-size:16px; transition: all 0.3s ease; background: rgba(255,255,255,0.9); }
input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1); background: white; }
input.full-width { width: 100%; box-sizing: border-box; margin-bottom: 16px; }
button.secondary{background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); box-shadow: 0 6px 20px rgba(107, 114, 128, 0.4), 0 0 0 1px rgba(255,255,255,0.1) inset;} 
button.secondary:hover{box-shadow: 0 10px 30px rgba(107, 114, 128, 0.6), 0 0 0 1px rgba(255,255,255,0.2) inset;}
button.guess{background: linear-gradient(135deg, #10b981 0%, #059669 100%); box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4), 0 0 0 1px rgba(255,255,255,0.1) inset;} 
button.guess:hover{box-shadow: 0 10px 30px rgba(16, 185, 129, 0.6), 0 0 0 1px rgba(255,255,255,0.2) inset;}
button.danger{background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4), 0 0 0 1px rgba(255,255,255,0.1) inset;}
button.danger:hover{box-shadow: 0 10px 30px rgba(239, 68, 68, 0.6), 0 0 0 1px rgba(255,255,255,0.2) inset;}
button.guest{background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4), 0 0 0 1px rgba(255,255,255,0.1) inset;}
button.guest:hover{box-shadow: 0 10px 30px rgba(139, 92, 246, 0.6), 0 0 0 1px rgba(255,255,255,0.2) inset;}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:14px;padding:4px;}
.card{background:linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);border-radius:18px;box-shadow:0 6px 16px rgba(0,0,0,.1);text-align:center;padding:10px;cursor:pointer;user-select:none;transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);border: 3px solid transparent;position:relative;overflow:hidden;}
.card::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent); transform: rotate(45deg); transition: all 0.6s; opacity: 0; }
.card:hover::before { opacity: 1; top: -10%; left: -10%; }
.card:hover{transform: translateY(-6px) scale(1.03); box-shadow:0 12px 28px rgba(0,0,0,.2);border-color: rgba(102, 126, 234, 0.3);}
.card.eliminated{opacity:.35;transform: scale(0.92);filter: grayscale(0.8);} 
.card.selected{border-color:#10b981; box-shadow:0 0 0 4px rgba(16, 185, 129, 0.3), 0 8px 20px rgba(16, 185, 129, 0.2);background:linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);}
.card img{width:100%;height:110px;object-fit:cover;border-radius:14px;transition: transform 0.3s ease;} 
.card:hover img{transform: scale(1.05);}
.name{margin-top:8px;font-size:14px;font-weight:700;color:#1f2937;letter-spacing:-0.2px;}
.delete-btn{position:absolute;top:50%;left:50%;transform:translate(-50%, -50%);width:54px;height:54px;border-radius:50%;background:linear-gradient(135deg, #ef4444 0%, #dc2626 100%);color:white;border:4px solid white;font-size:30px;font-weight:bold;line-height:1;cursor:pointer;opacity:0;transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);padding:0;box-shadow:0 8px 20px rgba(239, 68, 68, 0.7);z-index:10;}
.delete-btn:hover{transform:translate(-50%, -50%) scale(1.1);box-shadow:0 12px 28px rgba(239, 68, 68, 0.8);}
.card:hover + .delete-btn, .delete-btn:hover{opacity:1;}
.hidden{display:none;} 
.secret-display{text-align:center;font-weight:700;margin-bottom:12px;font-size:20px;color:#10b981;text-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);padding:12px;background:rgba(16, 185, 129, 0.1);border-radius:12px;border:2px solid rgba(16, 185, 129, 0.3);}
.pass-screen,.win-screen{position:fixed;inset:0;background:linear-gradient(135deg, #1e293b 0%, #0f172a 100%);color:white;display:none;align-items:center;justify-content:center;flex-direction:column;z-index:999;text-align:center;}
.pass-screen::before,.win-screen::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(circle at 50% 50%, rgba(102, 126, 234, 0.1) 0%, transparent 50%); animation: pulse 3s ease-in-out infinite; }
@keyframes pulse { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }
.pass-screen h1,.win-screen h1{font-size:36px;margin-bottom:20px;font-weight:800;position:relative;z-index:1;text-shadow: 0 4px 8px rgba(0,0,0,0.3);} 
.pass-screen button,.win-screen button{background: linear-gradient(135deg, #10b981 0%, #059669 100%);font-size:18px;box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5), 0 0 0 1px rgba(255,255,255,0.1) inset;position:relative;z-index:1;}
.confetti{position:fixed;width:12px;height:12px;animation:fall 3s linear forwards;z-index:1000;border-radius:50%;}
.tab-buttons{display:flex;gap:6px;margin-bottom:28px;border-radius:14px;overflow:hidden;background:rgba(243, 244, 246, 0.8);padding:6px;backdrop-filter:blur(10px);}
.tab-buttons button{flex:1;border-radius:10px;margin:0;min-width:0;background:transparent;color:#6b7280;box-shadow:none;font-weight:700;font-size:15px;}
.tab-buttons button.active{background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:white;box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4), 0 0 0 1px rgba(255,255,255,0.2) inset;}
.tab-buttons button:hover{transform:none;}
.user-info{text-align:center;padding:16px 24px;background:rgba(255,255,255,0.95);border-radius:18px;margin-bottom:20px;box-shadow:0 6px 16px rgba(0,0,0,0.15);backdrop-filter:blur(20px);font-weight:600;color:#1f2937;font-size:15px;border:1px solid rgba(255,255,255,0.5);}
@keyframes fall{0%{transform:translateY(0) rotate(0deg);}100%{transform:translateY(100vh) rotate(720deg);}}
@media(min-width:700px){.grid{grid-template-columns:repeat(auto-fill,minmax(140px,1fr));}.card img{height:140px;}}
</style>
</head>
<body>
<div id="authScreen" class="auth-box">
  <h1>üéÆ Custom Guess Who</h1>
  <p style="text-align:center;color:#6b7280;margin-bottom:28px;font-size:15px;">Create an account to save your rosters permanently, or play as a guest</p>
  
  <div class="tab-buttons">
    <button id="loginTab" class="active" onclick="showTab('login')">Login</button>
    <button id="signupTab" onclick="showTab('signup')">Sign Up</button>
  </div>
  
  <div id="loginForm">
    <div id="loginMessage" style="display:none;background:#fef2f2;border:1px solid #fecaca;color:#991b1b;padding:12px;border-radius:12px;margin-bottom:14px;font-size:14px;"></div>
    <input id="loginEmail" type="email" class="full-width" placeholder="Email" />
    <input id="loginPassword" type="password" class="full-width" placeholder="Password" />
    <button onclick="handleLogin()" style="width:100%;margin-bottom:14px;">Login</button>
  </div>
  
  <div id="signupForm" class="hidden">
    <div id="signupMessage" style="display:none;background:#fef2f2;border:1px solid #fecaca;color:#991b1b;padding:12px;border-radius:12px;margin-bottom:14px;font-size:14px;"></div>
    <input id="signupEmail" type="email" class="full-width" placeholder="Email" />
    <input id="signupPassword" type="password" class="full-width" placeholder="Password" />
    <input id="signupPasswordConfirm" type="password" class="full-width" placeholder="Confirm Password" />
    <button onclick="handleSignup()" style="width:100%;margin-bottom:14px;">Create Account</button>
  </div>
  
  <div style="text-align:center;margin-top:20px;padding-top:20px;border-top:2px solid #f3f4f6;">
    <p style="color:#6b7280;font-size:14px;margin-bottom:10px;">Don't want to create an account?</p>
    <button onclick="continueAsGuest()" class="guest" style="width:100%;">Continue as Guest</button>
    <p style="color:#9ca3af;font-size:13px;margin-top:10px;">Guest mode: Your data won't be saved</p>
  </div>
</div>

<div id="mainApp" class="hidden">

<!-- Error/Info Message Bar -->
<div id="messageBar" style="display:none;position:fixed;top:20px;left:50%;transform:translateX(-50%);max-width:600px;width:90%;z-index:2000;padding:16px 20px;border-radius:14px;box-shadow:0 10px 40px rgba(0,0,0,0.3);backdrop-filter:blur(10px);font-size:15px;font-weight:600;text-align:center;">
  <div id="messageContent"></div>
  <button onclick="hideMessage()" style="margin-top:12px;min-width:100px;padding:8px 16px;font-size:14px;">Got it</button>
</div>

<h1>üéÆ Custom Guess Who ‚Äì Two Player</h1>

<div id="rosterBox" class="box">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
    <h3 style="margin:0;">Custom Roster</h3>
    <button onclick="logout()" class="secondary" style="min-width:100px;font-size:14px;padding:10px 16px;">Logout</button>
  </div>
  <div id="storageInfo" style="text-align:center;font-size:13px;color:#6b7280;margin-bottom:12px;padding:8px;background:rgba(102,126,234,0.05);border-radius:10px;">
    <span id="storageText">Loading storage info...</span>
  </div>
  <p style="text-align:center;font-size:15px;color:#6b7280;margin-bottom:20px;">Add people once ‚Äî they stay for every game. <strong style="color:#667eea;">Click people to select them</strong> (green highlight) for the game.</p>
  <div class="controls">
    <input id="nameInput" placeholder="Name" />
    <input id="imgInput" type="file" accept="image/*" style="display:none;" />
    <label for="imgInput" style="padding:10px 14px;border:2px dashed #667eea;border-radius:12px;cursor:pointer;background:rgba(102,126,234,0.1);color:#667eea;font-weight:600;font-size:14px;display:inline-block;transition:all 0.3s ease;">
      üì∑ Choose Image
    </label>
    <button onclick="addCharacter()">Add to Roster</button>
  </div>
  <div id="rosterGrid" class="grid"></div>
  <div class="controls">
    <button onclick="beginSetup()">Start Game (Same Phone)</button>
    <button class="guest" onclick="showSocketMultiplayerModal()" title="Play on two different devices using server">Play on Two Screens</button>
  </div>
</div>

<div id="setupBox" class="box hidden">
  <h2>Game Setup</h2>
  <div id="secretDisplay" class="secret-display"></div>
  <p style="text-align:center;font-size:15px;color:#6b7280;margin-bottom:18px;">
    <span id="setupPlayerLabel"></span> secretly pick one person from below
  </p>
  <div id="setupGrid" class="grid"></div>
  <div class="controls">
    <button id="confirmBtn" onclick="confirmSecret()">Confirm Selection</button>
  </div>
</div>

<div id="gameBox" class="box hidden">
  <h2><span id="turnDisplay">Player 1's Turn</span></h2>
  <div id="gameSecretDisplay" class="secret-display"></div>
  <div id="gameGrid" class="grid"></div>
  <div class="controls">
    <button id="passBtn" onclick="passPhone()">Pass Phone</button>
    <button class="guess" onclick="makeGuess()">Make a Guess</button>
    <button class="danger" onclick="restartGame()">Restart Game</button>
  </div>
</div>

</div>

<!-- PASS PHONE SCREEN -->
<div id="passScreen" class="pass-screen">
  <h1>Pass Phone to <span id="passToPlayer">Player 2</span></h1>
  <button onclick="continueAfterPass()">I'm <span id="passToPlayer2">Player 2</span> ‚Äì Continue</button>
</div>

<!-- WIN SCREEN -->
<div id="winScreen" class="win-screen">
  <h1 id="winMessage">Player 1 Wins!</h1>
  <p style="font-size:18px;margin-bottom:20px;position:relative;z-index:1;opacity:0.9;" id="winDetails">They guessed correctly!</p>
  <button onclick="restartGame()">Play Again</button>
</div>

<!-- Socket.IO Multiplayer Modal -->
<div id="socketMultiplayerModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:1000;align-items:center;justify-content:center;">
  <div style="background:rgba(255,255,255,0.98);border-radius:24px;padding:40px;max-width:500px;width:90%;max-height:90vh;overflow-y:auto;position:relative;">
    <button onclick="closeSocketModal()" style="position:absolute;top:16px;right:16px;min-width:auto;padding:8px 12px;font-size:20px;background:transparent;color:#6b7280;box-shadow:none;" title="Close">‚úï</button>
    
    <h2 style="color:#1f2937;margin-bottom:12px;">üéÆ Two Screen Mode</h2>
    <p style="color:#6b7280;font-size:14px;margin-bottom:24px;">Play on separate devices without passing the phone!</p>
    
    <div class="tab-buttons">
      <button id="createRoomTab" class="active" onclick="switchSocketTab('create')">Create Room</button>
      <button id="joinRoomTab" onclick="switchSocketTab('join')">Join Room</button>
    </div>
    
    <div id="createRoomSection">
      <div style="background:#ecfdf5;border:2px solid #10b981;border-radius:14px;padding:16px;margin-bottom:20px;color:#065f46;">
        <div style="font-weight:700;margin-bottom:8px;">üìã How it works:</div>
        <div style="font-size:14px;line-height:1.6;">
          1. Click "Create Room" to generate a code<br>
          2. Share the code with Player 2<br>
          3. Player 2 joins using the code<br>
          4. Start playing on separate screens!
        </div>
      </div>
      <button onclick="createSocketRoom()" style="width:100%;">Create Room</button>
    </div>
    
    <div id="joinRoomSection" class="hidden">
      <p style="color:#6b7280;font-size:14px;margin-bottom:16px;">Enter the 6-character room code from Player 1:</p>
      <input id="socketRoomInput" type="text" class="full-width" placeholder="Enter room code" maxlength="6" style="text-transform:uppercase;text-align:center;font-size:24px;font-weight:700;letter-spacing:4px;" />
      <button onclick="joinSocketRoom()" style="width:100%;">Join Room</button>
    </div>
  </div>
</div>

<script>
// ========================================
// üîß SETUP INSTRUCTIONS
// ========================================
// 
// TO USE TWO-SCREEN MODE:
// 1. Deploy your server to Render (or another hosting service)
// 2. Get your server URL from Render (e.g., https://your-app.onrender.com)
// 3. Update the SERVER_URL below with your actual server URL
// 4. Make sure your server has CORS enabled for this client
//
// DEBUGGING TIPS:
// - Open browser console (F12) to see connection logs
// - Check if your server is running on Render
// - Look for "‚úÖ Connected to server successfully!" message
// - If you see connection errors, verify the SERVER_URL is correct
//
// ========================================

// === SERVER CONFIGURATION ===
// CHANGE THIS to your Render server URL (e.g., 'https://your-app-name.onrender.com')
const SERVER_URL = 'https://customguesswho.bsite.net';

// === AUTHENTICATION & STORAGE ===
let currentUser = null;
let isGuest = false;

// Prefer IndexedDB (much larger quota than localStorage). Fallback to localStorage if unavailable.
let useLocalStorage = false;
let idbDb = null;

// ---------- IndexedDB KV Store ----------
function openIdb() {
  return new Promise((resolve, reject) => {
    if (!("indexedDB" in window)) return reject(new Error("indexedDB not supported"));
    const req = indexedDB.open("guesswho_kv_v1", 1);
    req.onupgradeneeded = () => {
      const db = req.result;
      if (!db.objectStoreNames.contains("kv")) {
        db.createObjectStore("kv", { keyPath: "key" });
      }
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error || new Error("Failed to open IndexedDB"));
  });
}

async function checkStorageAvailability() {
  try {
    idbDb = await openIdb();
    useLocalStorage = false;
  } catch (err) {
    console.log("IndexedDB not available, using localStorage instead:", err?.message || err);
    useLocalStorage = true;
  }
}

// Initialize storage check
(async function() {
  await checkStorageAvailability();
})();

function idbGet(key) {
  return new Promise((resolve, reject) => {
    const tx = idbDb.transaction("kv", "readonly");
    const store = tx.objectStore("kv");
    const req = store.get(key);
    req.onsuccess = () => resolve(req.result ? req.result.value : null);
    req.onerror = () => reject(req.error || new Error("IDB get failed"));
  });
}

function idbSet(key, value) {
  return new Promise((resolve, reject) => {
    const tx = idbDb.transaction("kv", "readwrite");
    const store = tx.objectStore("kv");
    const req = store.put({ key, value });
    req.onsuccess = () => resolve();
    req.onerror = () => reject(req.error || new Error("IDB set failed"));
  });
}

async function getItem(key) {
  if (useLocalStorage) {
    return localStorage.getItem(key);
  } else {
    return await idbGet(key);
  }
}

async function setItem(key, value) {
  if (useLocalStorage) {
    localStorage.setItem(key, value);
  } else {
    await idbSet(key, value);
  }
}

function showTab(tab) {
  document.getElementById('loginForm').classList.toggle('hidden', tab !== 'login');
  document.getElementById('signupForm').classList.toggle('hidden', tab !== 'signup');
  document.getElementById('loginTab').classList.toggle('active', tab === 'login');
  document.getElementById('signupTab').classList.toggle('active', tab === 'signup');
}

async function handleLogin() {
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;
  const messageDiv = document.getElementById('loginMessage');
  
  if (!email || !password) {
    messageDiv.textContent = 'Please enter both email and password';
    messageDiv.style.display = 'block';
    return;
  }
  
  // Get stored user data
  const storedPassword = await getItem('password_' + email);
  
  if (!storedPassword) {
    messageDiv.textContent = 'Account not found. Please sign up.';
    messageDiv.style.display = 'block';
    return;
  }
  
  if (storedPassword !== password) {
    messageDiv.textContent = 'Incorrect password';
    messageDiv.style.display = 'block';
    return;
  }
  
  currentUser = { email };
  await setItem('currentUser', email);
  showMainApp();
}

async function handleSignup() {
  const email = document.getElementById('signupEmail').value.trim();
  const password = document.getElementById('signupPassword').value;
  const confirmPassword = document.getElementById('signupPasswordConfirm').value;
  const messageDiv = document.getElementById('signupMessage');
  
  if (!email || !password || !confirmPassword) {
    messageDiv.textContent = 'Please fill in all fields';
    messageDiv.style.display = 'block';
    return;
  }
  
  if (password !== confirmPassword) {
    messageDiv.textContent = 'Passwords do not match';
    messageDiv.style.display = 'block';
    return;
  }
  
  if (password.length < 6) {
    messageDiv.textContent = 'Password must be at least 6 characters';
    messageDiv.style.display = 'block';
    return;
  }
  
  // Check if account already exists
  const existingPassword = await getItem('password_' + email);
  if (existingPassword) {
    messageDiv.textContent = 'Account already exists. Please login.';
    messageDiv.style.display = 'block';
    return;
  }
  
  // Create account
  await setItem('password_' + email, password);
  currentUser = { email };
  await setItem('currentUser', email);
  showMainApp();
}

async function continueAsGuest() {
  isGuest = true;
  currentUser = { email: 'guest' };
  await setItem('currentUser', 'guest');
  showMainApp();
}

async function logout() {
  currentUser = null;
  isGuest = false;
  
  // Clear the current user session
  await setItem('currentUser', '');
  
  // Show auth screen
  document.getElementById('authScreen').classList.remove('hidden');
  document.getElementById('mainApp').classList.add('hidden');
  
  // Clear roster display
  roster = [];
  renderRoster();
  
  // Clear form inputs
  document.getElementById('loginEmail').value = '';
  document.getElementById('loginPassword').value = '';
  document.getElementById('signupEmail').value = '';
  document.getElementById('signupPassword').value = '';
  document.getElementById('signupPasswordConfirm').value = '';
  
  showMessage('success', 'Logged Out', 'You have been logged out successfully.');
}

async function showMainApp() {
  document.getElementById('authScreen').classList.add('hidden');
  document.getElementById('mainApp').classList.remove('hidden');
  
  await loadRoster();
  renderRoster();
  
  // Update logout button text to show current user
  const logoutBtn = document.querySelector('#rosterBox button[onclick="logout()"]');
  if (logoutBtn && currentUser) {
    const displayName = isGuest ? 'Guest' : currentUser.email.split('@')[0];
    logoutBtn.innerHTML = `üë§ ${displayName}<br><span style="font-size:11px;opacity:0.8;">Logout</span>`;
    logoutBtn.style.minWidth = '120px';
    logoutBtn.style.lineHeight = '1.3';
  }
}

// Check for existing session on load
window.addEventListener('DOMContentLoaded', async () => {
  // Wait for storage to be ready
  let attempts = 0;
  while ((idbDb === null && !useLocalStorage) && attempts < 50) {
    await new Promise(r => setTimeout(r, 100));
    attempts++;
  }
  
  const savedUser = await getItem('currentUser');
  
  if (savedUser && savedUser !== '') {
    currentUser = { email: savedUser };
    isGuest = (savedUser === 'guest');
    showMainApp();
  }
});

async function cancelAutoLogin() {
  // Clear the session
  await setItem('currentUser', '');
  currentUser = null;
  isGuest = false;
  
  // Reload the page to show fresh login screen
  location.reload();
}

async function loadRoster() {
  const key = isGuest ? 'guestRoster' : 'roster_' + currentUser.email;
  const saved = await getItem(key);
  if (saved) {
    try {
      roster = JSON.parse(saved);
    } catch (e) {
      console.error('Failed to parse roster:', e);
      roster = [];
    }
  }
}

async function saveRoster() {
  const key = isGuest ? 'guestRoster' : 'roster_' + currentUser.email;
  const data = JSON.stringify(roster);
  
  // Calculate approximate size in KB
  const sizeKB = (data.length / 1024).toFixed(2);
  console.log(`Roster size: ${sizeKB} KB (${roster.length} people)`);
  
  try {
    await setItem(key, data);
  } catch (error) {
    if (error.name === 'QuotaExceededError' || error.message.includes('quota')) {
      showMessage('error', `Storage Full!`, `Your roster is too large (${sizeKB} KB).<br><br><strong>How to fix:</strong><br>‚Ä¢ Delete some people from your roster<br>‚Ä¢ The images are automatically compressed to save space<br>‚Ä¢ ${useLocalStorage ? 'Your browser is using limited localStorage. Try a different browser for more space.' : 'You may need to clear some space.'}`);
      throw error;
    } else {
      console.error('Error saving roster:', error);
      throw error;
    }
  }
}

// === MESSAGE DISPLAY SYSTEM ===
function showMessage(type, title, message) {
  const messageBar = document.getElementById('messageBar');
  const messageContent = document.getElementById('messageContent');
  
  let bgColor, textColor, icon;
  
  if (type === 'error') {
    bgColor = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
    textColor = 'white';
    icon = '‚ö†Ô∏è';
  } else if (type === 'warning') {
    bgColor = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
    textColor = 'white';
    icon = '‚ö†Ô∏è';
  } else if (type === 'success') {
    bgColor = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
    textColor = 'white';
    icon = '‚úÖ';
  } else {
    bgColor = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
    textColor = 'white';
    icon = '‚ÑπÔ∏è';
  }
  
  messageBar.style.background = bgColor;
  messageBar.style.color = textColor;
  
  messageContent.innerHTML = `
    <div style="font-size:24px;margin-bottom:8px;">${icon}</div>
    <div style="font-size:18px;font-weight:800;margin-bottom:8px;">${title}</div>
    <div style="font-size:14px;font-weight:500;line-height:1.5;opacity:0.95;">${message}</div>
  `;
  
  messageBar.style.display = 'block';
  
  // Auto-hide success messages after 3 seconds
  if (type === 'success') {
    setTimeout(() => {
      hideMessage();
    }, 3000);
  }
}

function hideMessage() {
  const messageBar = document.getElementById('messageBar');
  messageBar.style.display = 'none';
}

// === GAME STATE ===
let roster = [];
let gamePool = [];
let p1secret = null;
let p2secret = null;
let currentPlayer = 1;
let setupPhase = 1;

let p1eliminated = [];
let p2eliminated = [];

// Socket.IO Multiplayer state
let socket = null;
let isSocketMultiplayer = false;
let socketRoomCode = null;
let socketPlayerNumber = null;

// === ROSTER MANAGEMENT ===
function compressImage(file, maxWidth = 300, maxHeight = 300, quality = 0.7) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = function(e) {
      const img = new Image();
      img.onload = function() {
        // Calculate new dimensions while maintaining aspect ratio
        let width = img.width;
        let height = img.height;
        
        if (width > height) {
          if (width > maxWidth) {
            height = (height * maxWidth) / width;
            width = maxWidth;
          }
        } else {
          if (height > maxHeight) {
            width = (width * maxHeight) / height;
            height = maxHeight;
          }
        }
        
        // Create canvas and compress
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        
        // Convert to compressed JPEG
        const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
        resolve(compressedDataUrl);
      };
      img.onerror = reject;
      img.src = e.target.result;
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

async function addCharacter() {
  const nameInput = document.getElementById('nameInput');
  const imgInput = document.getElementById('imgInput');
  const name = nameInput.value.trim();
  const file = imgInput.files[0];
  if (!name) {
    showMessage('error', 'Missing Name', 'Please enter a name for this person before adding them to your roster.');
    return;
  }
  if (!file) {
    showMessage('error', 'Missing Image', 'Please select an image for this person.<br><br><strong>How to add an image:</strong><br>‚Ä¢ Click the "üì∑ Choose Image" button<br>‚Ä¢ Select a photo from your device');
    return;
  }
  
  try {
    // Compress the image before storing
    const compressedImg = await compressImage(file);
    roster.push({ name, img: compressedImg });
    await saveRoster();
    renderRoster();
    nameInput.value = '';
    imgInput.value = '';
    showMessage('success', 'Person Added!', `${name} has been added to your roster.`);
  } catch (error) {
    console.error('Error processing image:', error);
    showMessage('error', 'Image Error', 'Failed to process this image.<br><br><strong>How to fix:</strong><br>‚Ä¢ Try a different image<br>‚Ä¢ Make sure the file is a valid image (JPG, PNG, etc.)<br>‚Ä¢ The image might be corrupted');
  }
}

function renderRoster() {
  const grid = document.getElementById('rosterGrid');
  grid.innerHTML = '';
  roster.forEach((char, index) => {
    const wrapper = document.createElement('div');
    wrapper.style.position = 'relative';
    
    const card = document.createElement('div');
    card.className = 'card';
    if (char.selected) card.classList.add('selected');
    card.innerHTML = `<img src="${char.img}" alt="${char.name}" /><div class="name">${char.name}</div>`;
    card.onclick = () => toggleSelect(index);
    
    const delBtn = document.createElement('button');
    delBtn.className = 'delete-btn';
    delBtn.textContent = '√ó';
    delBtn.onclick = (e) => {
      e.stopPropagation();
      deleteCharacter(index);
    };
    
    wrapper.appendChild(card);
    wrapper.appendChild(delBtn);
    grid.appendChild(wrapper);
  });
  
  // Update storage info
  updateStorageInfo();
}

function updateStorageInfo() {
  const key = isGuest ? 'guestRoster' : 'roster_' + currentUser.email;
  const data = JSON.stringify(roster);
  const sizeKB = (data.length / 1024).toFixed(1);
  const storageLimitKB = useLocalStorage ? 5120 : 10240; // 5MB for localStorage, 10MB estimate for IndexedDB (actual limit is much higher)
  const percentUsed = ((data.length / 1024 / storageLimitKB) * 100).toFixed(1);
  
  const storageText = document.getElementById('storageText');
  if (storageText) {
    const storageType = useLocalStorage ? 'localStorage' : 'IndexedDB';
    let color = '#10b981'; // green
    if (percentUsed > 75) color = '#f59e0b'; // orange
    if (percentUsed > 90) color = '#ef4444'; // red
    
    storageText.innerHTML = `
      üìä <strong>${roster.length}</strong> people | 
      <strong style="color:${color}">${sizeKB} KB</strong> used 
      ${useLocalStorage ? `(~${percentUsed}% of ${storageLimitKB/1024}MB limit)` : '(unlimited storage)'}
      | Using ${storageType}
    `;
  }
}

function toggleSelect(index) {
  roster[index].selected = !roster[index].selected;
  saveRoster();
  renderRoster();
}

function deleteCharacter(index) {
  const name = roster[index].name;
  showMessage('warning', 'Delete Person?', `Are you sure you want to delete <strong>${name}</strong> from your roster?<br><br>This cannot be undone.`);
  
  // Change the button to confirm deletion
  const messageBar = document.getElementById('messageBar');
  const button = messageBar.querySelector('button');
  button.textContent = 'Cancel';
  button.onclick = () => hideMessage();
  
  // Add a delete button
  const deleteBtn = document.createElement('button');
  deleteBtn.textContent = 'Delete';
  deleteBtn.className = 'danger';
  deleteBtn.style.marginLeft = '10px';
  deleteBtn.onclick = () => {
    roster.splice(index, 1);
    saveRoster();
    renderRoster();
    hideMessage();
    showMessage('success', 'Deleted', `${name} has been removed from your roster.`);
  };
  button.parentNode.appendChild(deleteBtn);
}

// === GAME FLOW ===
function beginSetup() {
  gamePool = roster.filter(c => c.selected);
  if (gamePool.length < 2) {
    showMessage('error', 'Not Enough People Selected', 'You need to select at least 2 people to play.<br><br><strong>How to select people:</strong><br>‚Ä¢ Click on people in your roster (they will have a green border)<br>‚Ä¢ Select at least 2 people<br>‚Ä¢ Then click "Start Game"');
    return;
  }
  
  // Reset for new game
  p1secret = null;
  p2secret = null;
  p1eliminated = [];
  p2eliminated = [];
  currentPlayer = 1;
  setupPhase = 1;
  isSocketMultiplayer = false;
  
  document.getElementById('rosterBox').classList.add('hidden');
  document.getElementById('setupBox').classList.remove('hidden');
  renderSetup();
}

function renderSetup() {
  const grid = document.getElementById('setupGrid');
  const label = document.getElementById('setupPlayerLabel');
  label.textContent = `Player ${setupPhase}:`;
  
  grid.innerHTML = '';
  gamePool.forEach((char, idx) => {
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `<img src="${char.img}" alt="${char.name}" /><div class="name">${char.name}</div>`;
    card.onclick = () => selectSecret(idx);
    grid.appendChild(card);
  });
  
  document.getElementById('secretDisplay').textContent = '';
  document.getElementById('confirmBtn').disabled = true;
}

function selectSecret(idx) {
  const secret = gamePool[idx];
  document.getElementById('secretDisplay').textContent = `You picked: ${secret.name}`;
  
  if (setupPhase === 1) {
    p1secret = secret;
  } else {
    p2secret = secret;
  }
  
  document.getElementById('confirmBtn').disabled = false;
}

function confirmSecret() {
  if (setupPhase === 1) {
    setupPhase = 2;
    showPassScreen(2);
  } else {
    startGame();
  }
}

function showPassScreen(toPlayer) {
  document.getElementById('passToPlayer').textContent = `Player ${toPlayer}`;
  document.getElementById('passToPlayer2').textContent = `Player ${toPlayer}`;
  document.getElementById('passScreen').style.display = 'flex';
}

function continueAfterPass() {
  document.getElementById('passScreen').style.display = 'none';
  if (setupPhase === 2) {
    renderSetup();
  } else {
    renderGame();
  }
}

function startGame() {
  currentPlayer = 1;
  document.getElementById('setupBox').classList.add('hidden');
  document.getElementById('gameBox').classList.remove('hidden');
  showPassScreen(1);
}

function renderGame() {
  const grid = document.getElementById('gameGrid');
  const turnDisplay = document.getElementById('turnDisplay');
  const secretDisplay = document.getElementById('gameSecretDisplay');
  const passBtn = document.getElementById('passBtn');
  
  // Determine if we're in two-screen mode
  const isTwoScreenMode = isSocketMultiplayer;
  
  // Update button text based on mode
  if (isTwoScreenMode) {
    passBtn.textContent = 'End Turn';
  } else {
    passBtn.textContent = 'Pass Phone';
  }
  
  // Disable button if it's not the player's turn in two-screen mode
  if (isTwoScreenMode && socketPlayerNumber !== currentPlayer) {
    passBtn.disabled = true;
  } else {
    passBtn.disabled = false;
  }
  
  turnDisplay.textContent = `Player ${currentPlayer}'s Turn`;
  
  const mySecret = currentPlayer === 1 ? p1secret : p2secret;
  const myEliminated = currentPlayer === 1 ? p1eliminated : p2eliminated;
  
  secretDisplay.textContent = `Your secret: ${mySecret.name}`;
  
  grid.innerHTML = '';
  gamePool.forEach((char, idx) => {
    const card = document.createElement('div');
    card.className = 'card';
    if (myEliminated.includes(idx)) {
      card.classList.add('eliminated');
    }
    card.innerHTML = `<img src="${char.img}" alt="${char.name}" /><div class="name">${char.name}</div>`;
    card.onclick = () => toggleEliminate(idx);
    grid.appendChild(card);
  });
}

function toggleEliminate(idx) {
  // In socket multiplayer, only allow current player to eliminate
  if (isSocketMultiplayer && socketPlayerNumber !== currentPlayer) {
    return;
  }
  
  const myEliminated = currentPlayer === 1 ? p1eliminated : p2eliminated;
  const index = myEliminated.indexOf(idx);
  if (index > -1) {
    myEliminated.splice(index, 1);
  } else {
    myEliminated.push(idx);
  }
  
  // Sync elimination state in socket multiplayer
  if (isSocketMultiplayer && socket) {
    socket.emit('eliminate-card', {
      roomCode: socketRoomCode,
      player: currentPlayer,
      cardIndex: idx,
      eliminated: myEliminated.includes(idx)
    });
  }
  
  renderGame();
}

function passPhone() {
  // In two-screen mode, check if it's the player's turn
  if (isSocketMultiplayer) {
    if (socketPlayerNumber !== currentPlayer) {
      return; // Button should be disabled, but just in case
    }
    
    // Emit turn end to server
    if (socket) {
      socket.emit('end-turn', { roomCode: socketRoomCode });
    }
  } else {
    // Same phone mode
    currentPlayer = currentPlayer === 1 ? 2 : 1;
    showPassScreen(currentPlayer);
  }
}

function makeGuess() {
  // In socket multiplayer, only allow current player to guess
  if (isSocketMultiplayer && socketPlayerNumber !== currentPlayer) {
    showMessage('error', 'Not Your Turn', "You can't make a guess when it's not your turn!<br><br><strong>Wait for:</strong><br>‚Ä¢ The other player to end their turn<br>‚Ä¢ The turn indicator to show your name");
    return;
  }
  
  const opponentSecret = currentPlayer === 1 ? p2secret : p1secret;
  
  // Show custom guess input
  showMessage('info', 'üéØ Make Your Guess', `Who do you think Player ${currentPlayer === 1 ? 2 : 1}'s person is?<br><br>Type their name below:`);
  
  const messageBar = document.getElementById('messageBar');
  const messageContent = document.getElementById('messageContent');
  
  // Add input field
  const input = document.createElement('input');
  input.type = 'text';
  input.placeholder = 'Enter name...';
  input.style.cssText = 'width:100%;padding:12px;border-radius:10px;border:2px solid rgba(255,255,255,0.3);background:rgba(255,255,255,0.95);margin:12px 0;font-size:16px;color:#1f2937;';
  messageContent.appendChild(input);
  input.focus();
  
  // Update buttons
  const existingButtons = messageBar.querySelectorAll('button');
  existingButtons.forEach(b => b.remove());
  
  const buttonContainer = document.createElement('div');
  buttonContainer.style.cssText = 'display:flex;gap:10px;justify-content:center;margin-top:12px;';
  
  const cancelBtn = document.createElement('button');
  cancelBtn.textContent = 'Cancel';
  cancelBtn.className = 'secondary';
  cancelBtn.onclick = () => hideMessage();
  
  const guessBtn = document.createElement('button');
  guessBtn.textContent = 'Submit Guess';
  guessBtn.className = 'guess';
  guessBtn.onclick = () => {
    const guess = input.value.trim();
    if (!guess) {
      input.style.borderColor = '#ef4444';
      return;
    }
    
    const correct = guess.toLowerCase() === opponentSecret.name.toLowerCase();
    hideMessage();
    
    if (correct) {
      showWinScreen(currentPlayer, opponentSecret.name);
      
      // Emit win to server if in socket multiplayer
      if (isSocketMultiplayer && socket) {
        socket.emit('player-won', {
          roomCode: socketRoomCode,
          winner: currentPlayer,
          secretName: opponentSecret.name
        });
      }
    } else {
      showMessage('error', 'Wrong Guess!', `That's not correct. The game continues.<br><br><strong>Keep playing:</strong><br>‚Ä¢ Ask more questions<br>‚Ä¢ Eliminate more people<br>‚Ä¢ Try guessing again when you're sure`);
    }
  };
  
  buttonContainer.appendChild(cancelBtn);
  buttonContainer.appendChild(guessBtn);
  messageBar.appendChild(buttonContainer);
  
  // Allow Enter key to submit
  input.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      guessBtn.click();
    }
  });
}

function showWinScreen(winner, secretName) {
  document.getElementById('winMessage').textContent = `Player ${winner} Wins! üéâ`;
  document.getElementById('winDetails').textContent = `They correctly guessed: ${secretName}`;
  document.getElementById('winScreen').style.display = 'flex';
  launchConfetti();
}

function launchConfetti() {
  const colors = ['#667eea', '#764ba2', '#10b981', '#ef4444', '#f59e0b'];
  for (let i = 0; i < 80; i++) {
    setTimeout(() => {
      const confetti = document.createElement('div');
      confetti.className = 'confetti';
      confetti.style.left = Math.random() * 100 + 'vw';
      confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
      confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
      document.body.appendChild(confetti);
      setTimeout(() => confetti.remove(), 3000);
    }, i * 30);
  }
}

function restartGame() {
  document.getElementById('winScreen').style.display = 'none';
  document.getElementById('gameBox').classList.add('hidden');
  document.getElementById('rosterBox').classList.remove('hidden');
  
  // Clean up socket multiplayer state if active
  if (isSocketMultiplayer) {
    cancelSocketRoom();
  }
}

// === SOCKET.IO MULTIPLAYER ===
function initSocketIO() {
  if (socket) return;
  
  console.log('Connecting to server:', SERVER_URL);
  
  socket = io(SERVER_URL, {
    transports: ['websocket', 'polling'],
    reconnection: true,
    reconnectionDelay: 1000,
    reconnectionAttempts: 5
  });
  
  socket.on('connect', () => {
    console.log('‚úÖ Connected to server successfully!');
    showMessage('success', 'Connected', 'Successfully connected to game server!');
  });
  
  socket.on('connect_error', (error) => {
    console.error('‚ùå Connection error:', error);
    showMessage('error', 'Connection Failed', `Could not connect to the game server.<br><br><strong>Server:</strong> ${SERVER_URL}<br><br><strong>How to fix:</strong><br>‚Ä¢ Check that your Render server is running<br>‚Ä¢ Make sure the SERVER_URL at the top of the HTML file matches your Render URL<br>‚Ä¢ Check browser console (F12) for more details`);
  });
  
  socket.on('disconnect', () => {
    console.log('Disconnected from server');
  });
  
  socket.on('player-joined', (data) => {
    if (socketPlayerNumber === 1) {
      // Player 1 sees that Player 2 has joined
      const statusDiv = document.getElementById('multiplayerStatus');
      if (statusDiv) {
        statusDiv.innerHTML = '‚úÖ Player 2 has joined! You can now start the game.';
      }
      
      // Remove instructions and show start button
      const instructions = document.getElementById('multiplayerInstructions');
      if (instructions) instructions.remove();
      
      const controlsDiv = document.querySelector('#rosterBox > .controls');
      if (controlsDiv) {
        controlsDiv.innerHTML = `
          <button onclick="startSocketMultiplayerGame()" class="guess">Start Game</button>
          <button onclick="cancelSocketRoom()" class="secondary">Cancel</button>
        `;
      }
    }
  });
  
  socket.on('game-started', (data) => {
    if (socketPlayerNumber === 2) {
      // Player 2 receives game start
      gamePool = data.gamePool;
      
      // Close waiting modal
      const waitingModal = document.getElementById('socketWaitingModal');
      if (waitingModal) waitingModal.remove();
      
      // Remove multiplayer banner and instructions
      const banner = document.getElementById('multiplayerBanner');
      if (banner) banner.remove();
      
      // Hide roster box
      document.getElementById('rosterBox').classList.add('hidden');
      
      // Go to setup for Player 2
      document.getElementById('setupBox').classList.remove('hidden');
      setupPhase = 2;
      renderSetup();
    }
  });
  
  socket.on('setup-complete', (data) => {
    if (socketPlayerNumber === 1) {
      // Player 1 receives Player 2's secret
      p2secret = data.p2secret;
      
      // Start the game
      currentPlayer = 1;
      document.getElementById('setupBox').classList.add('hidden');
      document.getElementById('gameBox').classList.remove('hidden');
      renderGame();
    }
  });
  
  socket.on('turn-changed', (data) => {
    currentPlayer = data.currentPlayer;
    renderGame();
  });
  
  socket.on('card-eliminated', (data) => {
    // Update the opponent's eliminated cards
    if (data.player !== socketPlayerNumber) {
      const eliminated = data.player === 1 ? p1eliminated : p2eliminated;
      const cardIndex = data.cardIndex;
      
      if (data.eliminated) {
        if (!eliminated.includes(cardIndex)) {
          eliminated.push(cardIndex);
        }
      } else {
        const idx = eliminated.indexOf(cardIndex);
        if (idx > -1) {
          eliminated.splice(idx, 1);
        }
      }
      
      renderGame();
    }
  });
  
  socket.on('game-won', (data) => {
    showWinScreen(data.winner, data.secretName);
  });
  
  socket.on('error', (data) => {
    showMessage('error', 'Game Error', data.message || 'An error occurred during the game.<br><br>You may need to restart the game.');
  });
}

function showSocketMultiplayerModal() {
  document.getElementById('socketMultiplayerModal').style.display = 'flex';
  switchSocketTab('create');
}

function closeSocketModal() {
  document.getElementById('socketMultiplayerModal').style.display = 'none';
}

function switchSocketTab(tab) {
  document.getElementById('createRoomSection').classList.toggle('hidden', tab !== 'create');
  document.getElementById('joinRoomSection').classList.toggle('hidden', tab !== 'join');
  document.getElementById('createRoomTab').classList.toggle('active', tab === 'create');
  document.getElementById('joinRoomTab').classList.toggle('active', tab === 'join');
}

function createSocketRoom() {
    const selectedChars = roster.filter(c => c.selected);
    if (selectedChars.length < 2) {
        showMessage('error', 'Not Enough People Selected', 'You need to select at least 2 people for the game.<br><br><strong>How to fix:</strong><br>‚Ä¢ Go back to your roster<br>‚Ä¢ Click on people to select them (green border)<br>‚Ä¢ Select at least 2 people<br>‚Ä¢ Then try creating a room again');
        return;
    }
    
    // Initialize socket if needed and wait for connection
    if (!socket) {
        initSocketIO();
        // Wait a moment for socket to connect
        setTimeout(() => createSocketRoomAfterConnection(selectedChars), 1000);
    } else if (!socket.connected) {
        // Socket exists but not connected, wait for connection
        setTimeout(() => createSocketRoomAfterConnection(selectedChars), 1000);
    } else {
        createSocketRoomAfterConnection(selectedChars);
    }
}

function createSocketRoomAfterConnection(selectedChars) {
    if (!socket || !socket.connected) {
        console.error('Socket not connected. Socket exists:', !!socket, 'Connected:', socket?.connected);
        showMessage('error', 'Connection Error', `Unable to connect to the game server.<br><br><strong>Server:</strong> ${SERVER_URL}<br><br><strong>Debug info:</strong><br>‚Ä¢ Socket exists: ${!!socket}<br>‚Ä¢ Socket connected: ${socket?.connected || false}<br><br><strong>How to fix:</strong><br>‚Ä¢ Check your internet connection<br>‚Ä¢ Verify your Render server is running<br>‚Ä¢ Open browser console (F12) to see detailed error messages<br>‚Ä¢ Make sure CORS is enabled on your server`);
        return;
    }
    
    console.log('Emitting create-room event...');
    
    socket.emit('create-room', (response) => {
        console.log('Create room response:', response);
        
        if (response && response.success) {
            socketRoomCode = response.roomCode;
            socketPlayerNumber = 1;
            isSocketMultiplayer = true;
            gamePool = selectedChars;
            
            // Reset game state
            p1secret = null;
            p2secret = null;
            p1eliminated = [];
            p2eliminated = [];
            currentPlayer = 1;
            setupPhase = 1;
            
            closeSocketModal();
            
            // Show room info banner at top
            const infoBanner = document.createElement('div');
            infoBanner.id = 'multiplayerBanner';
            infoBanner.style.cssText = 'background:linear-gradient(135deg, #10b981 0%, #059669 100%);color:white;padding:20px;text-align:center;border-radius:18px;margin:16px auto;max-width:1000px;box-shadow:0 6px 20px rgba(16,185,129,0.4);position:relative;z-index:1;';
            infoBanner.innerHTML = `
                <div style="font-weight:700;font-size:18px;margin-bottom:8px;">üéÆ Two Screen Mode Active</div>
                <div style="font-size:15px;margin-bottom:12px;">
                    Room Code: <span style="font-size:28px;font-weight:800;letter-spacing:4px;background:rgba(255,255,255,0.2);padding:8px 16px;border-radius:10px;display:inline-block;margin:0 8px;">${socketRoomCode}</span>
                </div>
                <div id="multiplayerStatus" style="font-size:13px;opacity:0.9;">‚è≥ Waiting for Player 2 to join...</div>
            `;
            
            // Insert at the very top of mainApp
            const mainApp = document.getElementById('mainApp');
            mainApp.insertBefore(infoBanner, mainApp.firstChild);
            
            // Add instructions to roster box
            const rosterBox = document.getElementById('rosterBox');
            const instructionDiv = document.createElement('div');
            instructionDiv.id = 'multiplayerInstructions';
            instructionDiv.style.cssText = 'background:#ecfdf5;border:2px solid #10b981;border-radius:14px;padding:16px;margin-bottom:20px;color:#065f46;';
            instructionDiv.innerHTML = `
                <div style="font-weight:700;font-size:16px;margin-bottom:8px;">üìã Setup Instructions:</div>
                <div style="font-size:14px;line-height:1.6;">
                    1. Share the room code above with Player 2<br>
                    2. Wait for Player 2 to join<br>
                    3. Once joined, you'll see a "Start Game" button
                </div>
            `;
            rosterBox.insertBefore(instructionDiv, rosterBox.firstChild);
        } else {
            showMessage('error', 'Failed to Create Room', (response && response.error) || 'An unknown error occurred.<br><br><strong>Try:</strong><br>‚Ä¢ Check your internet connection<br>‚Ä¢ Try again in a moment');
        }
    });
}

function joinSocketRoom() {
    const code = document.getElementById('socketRoomInput').value.trim().toUpperCase();
    
    if (code.length !== 6) {
        showMessage('error', 'Invalid Room Code', 'The room code must be exactly 6 characters.<br><br><strong>How to fix:</strong><br>‚Ä¢ Ask Player 1 for the complete 6-character code<br>‚Ä¢ Make sure you entered all 6 characters');
        return;
    }
    
    // Initialize socket if needed
    if (!socket) {
        initSocketIO();
        setTimeout(() => joinSocketRoomAfterConnection(code), 1000);
    } else if (!socket.connected) {
        setTimeout(() => joinSocketRoomAfterConnection(code), 1000);
    } else {
        joinSocketRoomAfterConnection(code);
    }
}

function joinSocketRoomAfterConnection(code) {
    if (!socket || !socket.connected) {
        console.error('Socket not connected. Socket exists:', !!socket, 'Connected:', socket?.connected);
        showMessage('error', 'Connection Error', `Unable to connect to the game server.<br><br><strong>Server:</strong> ${SERVER_URL}<br><br><strong>Debug info:</strong><br>‚Ä¢ Socket exists: ${!!socket}<br>‚Ä¢ Socket connected: ${socket?.connected || false}<br><br><strong>How to fix:</strong><br>‚Ä¢ Check your internet connection<br>‚Ä¢ Verify your Render server is running<br>‚Ä¢ Open browser console (F12) to see detailed error messages<br>‚Ä¢ Make sure CORS is enabled on your server`);
        return;
    }
    
    console.log('Emitting join-room event with code:', code);
    
    socket.emit('join-room', code, (response) => {
        console.log('Join room response:', response);
        if (response && response.success) {
            socketRoomCode = response.roomCode;
            socketPlayerNumber = response.playerNumber;
            isSocketMultiplayer = true;
            
            closeSocketModal();
            
            // Show waiting room for Player 2
            const waitingModal = document.createElement('div');
            waitingModal.className = 'pass-screen';
            waitingModal.style.display = 'flex';
            waitingModal.style.zIndex = '1500';
            waitingModal.innerHTML = `
                <div style="background:rgba(255,255,255,0.98);border-radius:24px;padding:48px;max-width:500px;text-align:center;position:relative;z-index:1;">
                    <h2 style="color:#1f2937;margin-bottom:20px;">‚úÖ Joined Successfully!</h2>
                    <p style="color:#6b7280;margin-bottom:12px;">You are Player 2</p>
                    <div style="font-size:36px;margin:20px 0;">üéÆ</div>
                    <p style="color:#6b7280;font-size:14px;">Waiting for Player 1 to start the game...</p>
                    <div style="margin-top:20px;padding:12px;background:rgba(102,126,234,0.1);border-radius:12px;color:#667eea;font-size:13px;">
                        üí° Player 1 is selecting the people for this game
                    </div>
                    <button onclick="cancelSocketRoom()" class="secondary" style="margin-top:20px;">Leave Room</button>
                </div>
            `;
            waitingModal.id = 'socketWaitingModal';
            document.body.appendChild(waitingModal);
        } else {
            showMessage('error', 'Failed to Join Room', (response && response.error) || 'Could not join this room.<br><br><strong>Possible reasons:</strong><br>‚Ä¢ The room code is incorrect<br>‚Ä¢ The room is full<br>‚Ä¢ The room no longer exists<br><br>Double-check the code with Player 1');
        }
    });
}

function cancelSocketRoom() {
    isSocketMultiplayer = false;
    socketRoomCode = null;
    socketPlayerNumber = null;
    
    // Remove multiplayer UI elements
    const banner = document.getElementById('multiplayerBanner');
    if (banner) banner.remove();
    
    const instructions = document.getElementById('multiplayerInstructions');
    if (instructions) instructions.remove();
    
    const waitingModal = document.getElementById('socketWaitingModal');
    if (waitingModal) waitingModal.remove();
    
    // Restore original buttons
    const controlsDiv = document.querySelector('#rosterBox > .controls');
    if (controlsDiv) {
        controlsDiv.innerHTML = `
            <button onclick="beginSetup()">Start Game (Same Phone)</button>
            <button class="guest" onclick="showSocketMultiplayerModal()" title="Play on two different devices using server">Play on Two Screens</button>
        `;
    }
    
    if (socket) {
        socket.disconnect();
        socket = null;
    }
}

function startSocketMultiplayerGame() {
    // Player 1 starts the multiplayer game
    if (socketPlayerNumber !== 1 || !socket) return;
    
    // Emit game start to server
    socket.emit('start-game', {
        roomCode: socketRoomCode,
        gamePool: gamePool
    });
    
    // Remove multiplayer banner and instructions
    const banner = document.getElementById('multiplayerBanner');
    if (banner) banner.remove();
    
    const instructions = document.getElementById('multiplayerInstructions');
    if (instructions) instructions.remove();
    
    // Hide roster box
    document.getElementById('rosterBox').classList.add('hidden');
    
    // Go to setup for Player 1
    document.getElementById('setupBox').classList.remove('hidden');
    setupPhase = 1;
    renderSetup();
}

// Override confirmSecret for socket multiplayer
const originalConfirmSecret = confirmSecret;
confirmSecret = function() {
    if (!isSocketMultiplayer) {
        originalConfirmSecret();
        return;
    }
    
    if (setupPhase === 1 && socketPlayerNumber === 1) {
        // Player 1 confirms their secret, wait for Player 2
        setupPhase = 2;
        
        // Show waiting screen
        const waitingModal = document.createElement('div');
        waitingModal.className = 'pass-screen';
        waitingModal.style.display = 'flex';
        waitingModal.style.zIndex = '1500';
        waitingModal.innerHTML = `
            <div style="background:rgba(255,255,255,0.98);border-radius:24px;padding:48px;max-width:500px;text-align:center;position:relative;z-index:1;">
                <h2 style="color:#1f2937;margin-bottom:20px;">‚è≥ Waiting for Player 2</h2>
                <p style="color:#6b7280;font-size:14px;">Player 2 is selecting their secret person...</p>
                <div style="font-size:48px;margin:20px 0;">üéÆ</div>
            </div>
        `;
        waitingModal.id = 'socketWaitingModal';
        document.body.appendChild(waitingModal);
        
        document.getElementById('setupBox').classList.add('hidden');
        
    } else if (setupPhase === 2 && socketPlayerNumber === 2) {
        // Player 2 confirms their secret and sends to server
        socket.emit('complete-setup', {
            roomCode: socketRoomCode,
            p2secret: p2secret
        });
        
        // Remove setup box and show waiting
        document.getElementById('setupBox').classList.add('hidden');
        
        const waitingModal = document.createElement('div');
        waitingModal.className = 'pass-screen';
        waitingModal.style.display = 'flex';
        waitingModal.style.zIndex = '1500';
        waitingModal.innerHTML = `
            <div style="background:rgba(255,255,255,0.98);border-radius:24px;padding:48px;max-width:500px;text-align:center;position:relative;z-index:1;">
                <h2 style="color:#1f2937;margin-bottom:20px;">‚úÖ Setup Complete!</h2>
                <p style="color:#6b7280;font-size:14px;">Starting game...</p>
                <div style="font-size:48px;margin:20px 0;">üéÆ</div>
            </div>
        `;
        waitingModal.id = 'socketWaitingModal';
        document.body.appendChild(waitingModal);
        
        // Start game for both players
        setTimeout(() => {
            const modal = document.getElementById('socketWaitingModal');
            if (modal) modal.remove();
            
            currentPlayer = 1;
            document.getElementById('gameBox').classList.remove('hidden');
            renderGame();
        }, 1500);
    }
};

// Initialize Socket.IO when the main app is shown
const originalShowMainApp = showMainApp;
window.showMainApp = function() {
    originalShowMainApp();
    initSocketIO();
};

</script>
<!-- Socket.IO Client Library -->
<script src="/socket.io/socket.io.js"></script>
</body>
</html>
